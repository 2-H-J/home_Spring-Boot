<!DOCTYPE html>
<html>
!

<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
	<link rel="stylesheet" href="/css/board_view.css">
	<script>
		window.onload = () => {

			//좋아요 링크 클릭 -> 경고창 띄우기
			// 게시물 좋아요 --------------------------------------------------------------------------------
			document.querySelector('#btn_like').onclick = () => {
				//alert('좋아요 클릭')
				fetch('/board/like/[[${board.bno}]]')
					.then(response => response.json())
					.then((result) => {
						console.log(result);
						if (result.code == 2) {
							if (confirm(result.msg)) location.href = '/login/view';
						}
						else alert(result.msg);
						//좋아요 개수 갱신
						document.querySelector("#like_count").innerHTML = result.count;
					})
					.catch((error) => {
						console.log(error);
					})
			}

			// 게시물 싫어요 --------------------------------------------------------------------------------
			document.querySelector('#btn_hate').onclick = () => {
				fetch('/board/hate/[[${board.bno}]]')
					.then(response => response.json())
					.then((result) => {
						console.log(result);
						if (result.code == 2) {
							if (confirm(result.msg)) location.href = '/login/view';
						}
						else alert(result.msg);
						document.querySelector("#hate_count").innerHTML = result.count;
					})
					.catch((error) => {
						console.log(error);
					})
			}

			// 댓글 갯수 더보기----------------------------------------------------------------------------------------------------
			let commentCount = 6;
			document.querySelector('#btn_more').onclick = () => {

				fetch(`/board/comment/[[${board.bno}]]?start=${commentCount}`,).then(res => res.json())
					.then(result => {
						console.log(result);
						let tag = '';
						result.forEach(item => {
							tag += `<div class="comment">
							<p>
								<input type="hidden" name="cno" value="${item.con}">
								<span>작성자 : ${item.id} / </span>
								<span>작성일 : ${item.cdate} / </span>
								<span><a href="#" class="btn_comment_like">좋아요 : ${item.clike}</a></span>
								<span><a href="#" class="btn_comment_hate">싫어요 : ${item.chate}</a></span>
								</p>
								<p>${item.content}</p>
								</div>`;
						});
						document.querySelector('.comment_container').innerHTML += tag; // += 기존에 있는거에 더해서
						commentCount += result.length;

						window.scrollTo({
							top: document.body.scrollHeight,
							behavior: 'smooth' // 스크롤 애니메이션 추가
						});
					}).catch(error => {
						console.log(error);
					})
			}

			// 댓글 좋아요 ------------------------------------------------------------------------------------
			document.querySelector('.comment_container').onclick = (e) => {
				//댓글 좋아요 싫어요 눌렀을때만 반응하게끔 처리
				if (e.target.className != 'btn_comment_like' && e.target.className != 'btn_comment_hate') return;
				console.log(e.target);
				console.log(e.target.parentNode.parentNode.querySelector('input[name="cno"]').value);

				let cno = e.target.parentNode.parentNode.querySelector('input[name="cno"]').value;
				commentLikeHateAjax(e.target.className == 'btn_comment_like', cno, e.target);
			}
		}
		function commentLikeHateAjax(mode, cno, target) {
			let url = `/board/comment/${mode ? "like" : "hate"}/${cno}`;
			console.log(url);
			//ajax 호출
			fetch(url).then(response => response.json())
				.then(result => {
					console.log(result);
					if (result.code == 2) {
						alert(result.msg);
						location.href = '/login/view';
					}
					target.querySelector('span').innerHTML = result.count;
				}).catch(error => {
					console.log(error);
				});
		}
	</script>

</head>

<body>
	<th:block th:include="/fragments/header.html"></th:block> <!-- 공통 헤더 포함 -->
	<div id="container" class="container">
		<h2>글조회 페이지</h2>
		<table class="board-view-table">
			<tr>
				<th>글번호</th>
				<td>[[${board.bno}]]</td>
			</tr>
			<tr>
				<th>제목 : </th>
				<td th:text="${board.title }"></td>
			</tr>
			<tr>
				<th>작성자 : </th>
				<td>[[${board.nickName }]]</td>
			</tr>
			<tr>
				<th>조회수 : </th>
				<td>[[${board.bcount }]]</td>
			</tr>
			<tr>
				<td colspan="2">
					[(${board.content })]
				</td>
				<!-- <td colspan="2" th:utext="${board.content }"> 
				
			</td> -->
			</tr>
			<tr>
				<td colspan="2">
					<a href="#" id="btn_like">좋아요 : <span id="like_count">[[${board.blike }]]</span> </a>
					<a href="#" id="btn_hate">싫어요 : <span id="hate_count">[[${board.bhate }]]</span> </a>
				</td>
			</tr>
			<!-- 
			해당 글을 쓴 작성자에게만 수정, 삭제 버튼이 나오게끔 처리
		 -->
			<!-- <c:if test="${sessionScope.user.boardMemberId == board.boardMemberId }">
		 <tr>
			 <td colspan="2">
			 	<button id="btn_update">수정</button>
			 	<button id="btn_delete">삭제</button>
			 	<script>
			 		document.querySelector("#btn_update").onclick = () =>{
			 			location.href='./boardUpdateView.do?bno=${board.boardNo}';
			 		}
			 		document.querySelector("#btn_delete").onclick = () =>{
			 			location.href='./boardDelete.do?bno=${board.boardNo}';
			 		}
			 	</script>
			 </td>
	 	</tr>
		 </c:if> -->

			<tr>

			</tr>

			<tr>
				<td colspan="2">
					<!-- 댓글 입력 폼 -->
					<div class="comment_form" th:if="${session.user != null }">
						<form action="/board/comment" method="post">
							<input type="hidden" name="bno" th:value="${board.bno }">
							<textarea name="content" placeholder="댓글을 입력하세요"></textarea>
							<button>댓글작성</button>
						</form>
					</div>
					<div class="comment_form" th:if="${session.user == null }">
						<p><a href="/login/view">로그인 후 작성가능</a></p>
					</div>
				</td>
			</tr>
		</table>
		<hr>
		<!-- 
		댓글 내용을 출력, 댓글 번호(hidden), 작성일, 좋아요, 싫어요, 작성자, 댓글 내용 
		댓글 삭제 버튼 -> 작성자와 로그인한 사람이 일치할때
		
		작성자, 작성일, 좋아요, 싫어요
		댓글 내용
		삭제버튼
	 -->
		<!-- 댓글 리스트 5개씩 출력 -->
		<div class="comment_container">
			<div class="comment" th:each="comment : ${commentList }">
				<p>
					<input type="hidden" name="cno" th:value="${comment.cno }" />
					<span>작성자 : [[${comment.id }]] / </span>
					<span>작성일 : [[${comment.cdate }]] / </span>
					<span><a href="#" class="btn_comment_like">좋아요 : <span>[[${comment.clike }]]</span></a></span>
					<span><a href="#" class="btn_comment_hate">싫어요 : <span>[[${comment.chate}]]</span></a></span>
				</p>
				<p>[[${comment.content }]]</p>
				<a th:if="${session.user != null && session.user.id == comment.id }"
					href="@{/comment/delete/{cno}(cno=${comment.cno })}">댓글 삭제</a>
			</div>
		</div>
		<hr>
		<button type="button" id="btn_more">댓글 더보기</button>
		<button type="button" id="btn_page_up">제일 위로 가기</button>
	</div>
</body>

</html>